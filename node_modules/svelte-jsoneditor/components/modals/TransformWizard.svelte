<svelte:options immutable={true} />

<script>var _a, _b, _c, _d, _e, _f, _g;
import Select from 'svelte-select';
import { getNestedPaths } from '../../utils/arrayUtils.js';
import { stringifyPath } from '../../utils/pathUtils.js';
import { createDebug } from '../../utils/debug.js';
import { isEmpty, isEqual } from 'lodash-es';
import { setIn } from 'immutable-json-patch';
const debug = createDebug('jsoneditor:TransformWizard');
export let json;
export let queryOptions = {};
export let onChange;
// options
$: jsonIsArray = Array.isArray(json);
$: paths = jsonIsArray ? getNestedPaths(json) : [];
$: pathsIncludingObjects = jsonIsArray ? getNestedPaths(json, true) : [];
$: fieldOptions = paths.map(pathToOption);
$: projectionOptions = pathsIncludingObjects ? pathsIncludingObjects.map(pathToOption) : [];
const filterRelationOptions = ['==', '!=', '<', '<=', '>', '>='].map((relation) => ({
    value: relation,
    label: relation
}));
const sortDirectionOptions = [
    { value: 'asc', label: 'ascending' },
    { value: 'desc', label: 'descending' }
];
// TODO: the binding with the select boxes is very cumbersome. Can we simplify this?
let filterPath = ((_a = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.filter) === null || _a === void 0 ? void 0 : _a.path) ? pathToOption(queryOptions.filter.path) : null;
let filterRelation = ((_b = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.filter) === null || _b === void 0 ? void 0 : _b.relation)
    ? filterRelationOptions.find((option) => option.value === queryOptions.filter.relation)
    : null;
let filterValue = ((_c = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.filter) === null || _c === void 0 ? void 0 : _c.value) || '';
let sortPath = ((_d = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.sort) === null || _d === void 0 ? void 0 : _d.path) ? pathToOption(queryOptions.sort.path) : null;
let sortDirection = ((_e = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.sort) === null || _e === void 0 ? void 0 : _e.direction)
    ? sortDirectionOptions.find((option) => option.value === queryOptions.sort.direction)
    : null;
let projectionPaths = ((_f = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.projection) === null || _f === void 0 ? void 0 : _f.paths)
    ? queryOptions.projection.paths.map(pathToOption)
    : null;
$: fieldPath = ((_g = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.filter) === null || _g === void 0 ? void 0 : _g.path)
    ? fieldOptions.find((option) => { var _a; return isEqual(option.value, (_a = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.filter) === null || _a === void 0 ? void 0 : _a.path); })
    : null;
function pathToOption(path) {
    return {
        value: path,
        label: isEmpty(path) ? '(whole item)' : stringifyPath(path)
    };
}
function changeFilterPath(path) {
    var _a;
    if (!isEqual((_a = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.filter) === null || _a === void 0 ? void 0 : _a.path, path)) {
        debug('changeFilterPath', path);
        queryOptions = setIn(queryOptions, ['filter', 'path'], path, true);
        onChange(queryOptions);
    }
}
function changeFilterRelation(relation) {
    var _a;
    if (!isEqual((_a = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.filter) === null || _a === void 0 ? void 0 : _a.relation, relation)) {
        debug('changeFilterRelation', relation);
        queryOptions = setIn(queryOptions, ['filter', 'relation'], relation, true);
        onChange(queryOptions);
    }
}
function changeFilterValue(value) {
    var _a;
    if (!isEqual((_a = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.filter) === null || _a === void 0 ? void 0 : _a.value, value)) {
        debug('changeFilterValue', value);
        queryOptions = setIn(queryOptions, ['filter', 'value'], value, true);
        onChange(queryOptions);
    }
}
function changeSortPath(path) {
    var _a;
    if (!isEqual((_a = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.sort) === null || _a === void 0 ? void 0 : _a.path, path)) {
        debug('changeSortPath', path);
        queryOptions = setIn(queryOptions, ['sort', 'path'], path, true);
        onChange(queryOptions);
    }
}
function changeSortDirection(direction) {
    var _a;
    if (!isEqual((_a = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.sort) === null || _a === void 0 ? void 0 : _a.direction, direction)) {
        debug('changeSortDirection', direction);
        queryOptions = setIn(queryOptions, ['sort', 'direction'], direction, true);
        onChange(queryOptions);
    }
}
function changeProjectionPaths(paths) {
    var _a;
    if (!isEqual((_a = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.projection) === null || _a === void 0 ? void 0 : _a.paths, paths)) {
        debug('changeProjectionPaths', paths);
        queryOptions = setIn(queryOptions, ['projection', 'paths'], paths, true);
        onChange(queryOptions);
    }
}
$: changeFilterPath((filterPath === null || filterPath === void 0 ? void 0 : filterPath.value) || null);
$: changeFilterRelation((filterRelation === null || filterRelation === void 0 ? void 0 : filterRelation.value) || null);
$: changeFilterValue(filterValue || null);
$: changeSortPath((sortPath === null || sortPath === void 0 ? void 0 : sortPath.value) || null);
$: changeSortDirection((sortDirection === null || sortDirection === void 0 ? void 0 : sortDirection.value) || null);
$: changeProjectionPaths(projectionPaths ? projectionPaths.map((item) => item.value) : null);
</script>

<table class="jse-transform-wizard">
  <tr>
    <th>Filter</th>
    <td>
      <div class="jse-horizontal">
        <Select
          containerClasses="jse-filter-path"
          showIndicator
          items={fieldOptions}
          bind:value={filterPath}
        />
        <Select
          containerClasses="jse-filter-relation"
          showIndicator
          items={filterRelationOptions}
          bind:value={filterRelation}
        />
        <input class="jse-filter-value" bind:value={filterValue} />
      </div>
    </td>
  </tr>
  <tr>
    <th>Sort</th>
    <td>
      <div class="jse-horizontal">
        <Select
          containerClasses="jse-sort-path"
          showIndicator
          items={fieldOptions}
          bind:value={sortPath}
        />
        <Select
          containerClasses="jse-sort-direction"
          showIndicator
          items={sortDirectionOptions}
          bind:value={sortDirection}
        />
      </div>
    </td>
  </tr>
  <tr>
    <th>Pick</th>
    <td>
      <div class="jse-horizontal">
        <Select
          containerClasses="jse-projection-paths"
          isMulti
          showIndicator
          items={projectionOptions}
          bind:value={projectionPaths}
        />
      </div>
    </td>
  </tr>
</table>

<style src="./TransformWizard.scss">table.jse-transform-wizard {
  border-collapse: collapse;
  border-spacing: 0;
  width: 100%;
}
table.jse-transform-wizard input {
  font-family: inherit;
  font-size: inherit;
}
table.jse-transform-wizard tr th {
  font-weight: normal;
  text-align: left;
  width: 60px;
}
table.jse-transform-wizard tr td .jse-horizontal {
  width: 100%;
  display: flex;
  flex-direction: row;
  margin-bottom: calc(0.5 * var(--jse-padding));
}
table.jse-transform-wizard tr td .jse-horizontal :global(.selectContainer.jse-filter-path) {
  flex: 4;
  margin-right: calc(0.5 * var(--jse-padding));
}
table.jse-transform-wizard tr td .jse-horizontal :global(.selectContainer.jse-filter-relation) {
  flex: 1.5;
  margin-right: calc(0.5 * var(--jse-padding));
}
table.jse-transform-wizard tr td .jse-horizontal :global(.selectContainer.jse-sort-path) {
  flex: 3;
  margin-right: calc(0.5 * var(--jse-padding));
}
table.jse-transform-wizard tr td .jse-horizontal :global(.selectContainer.jse-sort-direction) {
  flex: 1;
}
table.jse-transform-wizard tr td .jse-horizontal :global(.selectContainer.jse-projection-paths) {
  flex: 1;
}
table.jse-transform-wizard tr td .jse-horizontal :global(.selectContainer input) {
  box-sizing: border-box;
}
table.jse-transform-wizard tr td .jse-horizontal .jse-filter-value {
  flex: 4;
  padding: 4px 8px;
  border: var(--jse-input-border);
  border-radius: var(--jse-input-radius);
  outline: none;
  background: var(--jse-input-background);
  color: inherit;
}
table.jse-transform-wizard tr td .jse-horizontal .jse-filter-value:focus {
  border: var(--jse-input-border-focus);
}</style>
