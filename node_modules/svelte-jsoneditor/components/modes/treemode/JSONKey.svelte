<svelte:options immutable={true} />

<script>import classnames from 'classnames';
import { initial } from 'lodash-es';
import { SELECTION_TYPE } from '../../../logic/selection';
import SearchResultHighlighter from './highlight/SearchResultHighlighter.svelte';
import EditableDiv from '../../controls/EditableDiv.svelte';
import { addNewLineSuffix } from '../../../utils/domUtils';
import { UPDATE_SELECTION } from '../../../constants';
export let path;
export let key;
export let onUpdateKey;
export let selection;
export let searchResult;
export let context;
$: selectedKey = selection && selection.type === SELECTION_TYPE.KEY;
$: editKey = !context.readOnly && selectedKey && selection && selection['edit'] === true;
function handleKeyDoubleClick(event) {
    if (!editKey && !context.readOnly) {
        event.preventDefault();
        context.onSelect({ type: SELECTION_TYPE.KEY, path, edit: true });
    }
}
function getKeyClass(key) {
    return classnames('jse-key', {
        'jse-empty': key === ''
    });
}
function handleChangeValue(newKey, updateSelection) {
    const updatedKey = onUpdateKey(key, context.normalization.unescapeValue(newKey));
    const updatedPath = initial(path).concat(updatedKey);
    if (updateSelection === UPDATE_SELECTION.NEXT_INSIDE) {
        context.onSelect({
            type: SELECTION_TYPE.KEY,
            path: updatedPath,
            next: true
        });
    }
    if (updateSelection === UPDATE_SELECTION.SELF) {
        context.onSelect({
            type: SELECTION_TYPE.KEY,
            path: updatedPath
        }, { ensureFocus: false });
    }
}
function handleCancelChange() {
    context.onSelect({ type: SELECTION_TYPE.KEY, path });
}
</script>

{#if editKey}
  <EditableDiv
    value={context.normalization.escapeValue(key)}
    shortText
    onChange={handleChangeValue}
    onCancel={handleCancelChange}
    onFind={context.onFind}
  />
{:else}
  <div data-type="selectable-key" class={getKeyClass(key)} on:dblclick={handleKeyDoubleClick}>
    {#if searchResult}
      <SearchResultHighlighter text={context.normalization.escapeValue(key)} {searchResult} />
    {:else}
      {addNewLineSuffix(context.normalization.escapeValue(key))}
    {/if}
  </div>
{/if}

<style src="./JSONKey.scss">.jse-key {
  display: inline-block;
  min-width: 2em;
  padding: 0 5px;
  box-sizing: border-box;
  outline: none;
  border-radius: 1px;
  vertical-align: top;
  color: var(--jse-key-color);
  word-break: normal;
  overflow-wrap: normal;
  white-space: pre-wrap;
}
.jse-key:hover {
  background: var(--jse-hover-background-color);
}
.jse-key:hover {
  background: var(--jse-hover-background-color);
}
.jse-key.jse-empty {
  min-width: 3em;
  outline: 1px dotted var(--jse-tag-background);
  -moz-outline-radius: 2px;
}
.jse-key.jse-empty::after {
  pointer-events: none;
  color: var(--jse-tag-background);
  content: "key";
}</style>
